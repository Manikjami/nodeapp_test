pipeline {
	agent any
	options {
            timeout(time: 20, unit: "MINUTES") 
            buildDiscarder logRotator(artifactDaysToKeepStr: "", artifactNumToKeepStr: "", daysToKeepStr: "2", numToKeepStr: "2")
        }  
		stages {
			stage('checkout scm') {
                steps {
                  checkout([$class: 'GitSCM', branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[credentialsId: 'gitcredentials', url: 'https://github.com/Manikjami/nodeapp_test.git']]])
				}
			}
			stage("Build"){
				steps{
					sh 'npm install'
				}
			}
			stage("building docker image") {
				steps {
					sh 'docker build -t manikjami/nodeapp:$BUILD_NUMBER .'
				}
			}
			stage('Docker Push') {
				steps {
					echo 'Pushing image'
					withCredentials([usernamePassword(credentialsId: 'gitcredentials', passwordVariable: 'dockerpasswordcreds', usernameVariable: 'dockerusernamecreds')]) {
						sh 'docker login -u $dockerusernamecreds -p $dockerpasswordcreds'
						sh 'docker push manikjami/nodeapp:$BUILD_NUMBER'
					}
				}
			} 
			stage ('Deploy') {
				steps {
					echo 'deploying docker image'
					sh '''
					docker ps -f name=nodesecond -q | xargs --no-run-if-empty docker container stop
					docker container ls -a -f name=nodesecond -q | xargs -r docker container rm
					docker run -d --name nodesecond -p 3000:3000 manikjami/nodeapp:$BUILD_NUMBER
					'''
				}
			}
		}
	}
